version: '3.8'

services:
  langfuse-web:
    image: langfuse/langfuse:3.39.0
    container_name: langfuse-web
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - langfuse-db
      - langfuse-redis
      - langfuse-clickhouse
      - langfuse-minio
    environment:
      # Database connection string
      - DATABASE_URL=postgresql://langfuse:langfuse@langfuse-db:5432/langfuse
      - DIRECT_URL=postgresql://langfuse:langfuse@langfuse-db:5432/langfuse

      # Redis Sidecar Connection
      - REDIS_HOST=langfuse-redis
      - REDIS_PORT=6379
      - REDIS_PORT=6379

      # ClickHouse Sidecar Connection (Mandatory for v3)
      - CLICKHOUSE_URL=http://langfuse-clickhouse:8123
      - CLICKHOUSE_MIGRATION_URL=clickhouse://langfuse-clickhouse:9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=langfuse
      - CLICKHOUSE_CLUSTER_ENABLED=false

      # Authentication Encryption Key
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - SALT=${SALT}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      # Hostname config
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - PORT=3000

      # MinIO S3 Configuration
      - LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse
      - LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://langfuse-minio:9000
      - LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1
      - LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=minioadmin
      - LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=minioadmin
      - LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  langfuse-db:
    image: postgres:latest
    container_name: langfuse-db
    restart: always
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=langfuse
      - POSTGRES_DB=langfuse
    volumes:
      - ${WEBAPP_STORAGE_HOME}/site/wwwroot/langfuse-data:/var/lib/postgresql/data

  langfuse-redis:
    image: redis:7-alpine
    container_name: langfuse-redis
    restart: always

  langfuse-clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: langfuse-clickhouse
    restart: always
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=langfuse
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  langfuse-minio:
    image: minio/minio:latest
    container_name: langfuse-minio
    command: server /data --console-address ":9001"
    restart: always
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ${WEBAPP_STORAGE_HOME}/site/wwwroot/langfuse-minio:/data
